<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <title>答题界面</title>
    <meta http-equiv="content-type" content="text/html charset=utf-8"/>
    <meta name="viewport" content="width=device-width">
    <link href="/css/demo.css" type="text/css" rel="stylesheet" charset="utf-8">
    <link href="/css/index.css" type="text/css" rel="stylesheet" charset="utf-8">
    <script src="/js/vue@2.6.10.js"></script>
    <script src="/js/axios@0.18.0.min.js"></script>
    <script src="/js/index.js"></script>
    <script src="/js/jquery.min.js"></script>
</head>
<body>
<div id="pop_container">
    <img id="popBox" src="/image/pop_box.png"></img>
    <div id="pop_msg">
        <p style="padding: 4px 0px;"><span style="color: #DCDCDC;">你还有 </span><span id="remain_text"
                                                                                    style="color: #FF8900;"></span><span
                style="color: #DCDCDC;"> 未完成，是否交卷？</span></p>
    </div>
    <button type="button" id="handIn_confirm" onclick="handInConfirm()"></button>
    <button type="button" id="handIn_cancel" onclick="handInCancel()"></button>
</div>
<div id="whole">
    <div id="top_bar"></div>
    <div id="app">
        <div id="musicBox">
            <audio id="stem_music" onended="musicEnd(0)"></audio>
            <audio id="option_a_music" onended="musicEnd(1)"></audio>
            <audio id="option_b_music" onended="musicEnd(2)"></audio>
            <audio id="option_c_music" onended="musicEnd(3)"></audio>
            <audio id="option_d_music" onended="musicEnd(4)"></audio>

        </div>
        <button type="button" id="back_button" @click="goBack"></button>
        <div id="main">
            <div id="header">
                <div id="container1">
                    <div id="heading">
                        <div id="heading1">Level {{ level }} Lesson {{ lesson }}</div>
                        <div id="heading2">智能推送练习</div>
                    </div>
                </div>
                <div id="container2">
                    <div id="heading3">
                        <div id="line"></div>
                        <ul class="time">
                            <li v-for="activity in activities">
                                <img :src="activity.src" :id="getId(activity.index)">
                                <p :id="getNum(activity.index)"><span>{{ activity.content }}</span></p>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <img id="link_left" src="/image/link1.png">
            <img id="link_right" src="/image/link1.png">
            <div id="question_card">
                <div id="book_container">
                    <img src="/image/book.png" id="book">
                    <div id="question_area">
                        <div id="image_container" style="display: none">
                            <div class="imgSize">
                                <img src="/image/logo.png" id="image" onload="changeSize(this,'stem')">
                                <!--                                        <img src="/image/testGif.gif" id="image">-->
                                <!--                                        <img src="/image/testGif2.gif" id="test" width="100px" height="100px">-->
                            </div>
                        </div>

                        <div id="question_info">
                            <p style="font-family: 'GothamRoundedMedium';color: #2A7DE1;font-size: 2.5rem;"><span>Q{{ num }}</span>
                            </p>
                            <div style="border-radius: 40px;background-color: #2A7DE1;font-family: 'Microsoft YaHei';color: white;font-weight: bold;font-size: 1.25rem;margin-left: 0.6rem;padding-left: 0.25rem;padding-right: 0.25rem;">
                                <p><span>{{ prob_type }}</span></p>
                            </div>
                        </div>
                        <div id="question_text">

                            <div id="last_span"><span style="line-height: 55px">{{ last_span_text }}</span><img
                                    v-if="stem_aud && stem_aud != ''" id="stem_audio" src="/image/audio-unchecked.png"
                                    @click="playAudio('stem')"><img v-if="stem_aud && stem_aud != ''"
                                                                    src="/image/finger.gif" class="finger"></div>

                        </div>
                        <div id="opt_part">
                            <div id="option_A" class="option" @click="chooseOption('a')">
                                <div id="question_a_text">A. {{ options.A }}</div>
                            </div>
                            <div id="option_B" class="option" @click="chooseOption('b')">
                                <div id="question_b_text">B. {{ options.B }}</div>
                            </div>
                            <div id="option_C" class="option" style="display: none;" @click="chooseOption('c')">
                                <div id="question_c_text">C. {{ options.C }}</div>
                            </div>
                            <div id="option_D" class="option" style="display: none;" @click="chooseOption('d')">
                                <div id="question_d_text">D. {{ options.D }}</div>
                            </div>
                            <button type="button" id="last_button" @click="lastProblem"></button>
                            <button type="button" id="next_button" @click="nextProblem"></button>
                        </div>
                        <!--                                <div id="tingyinxuanwen_part" style="display: none">-->

                        <!--                                    <div id="option-A" class="option_1" @click="chooseOption4('a')">-->
                        <!--                                        <div id="question_a_text">A. {{ options.A }}</div>-->
                        <!--                                    </div>-->
                        <!--                                    <div id="option-B" class="option_1" @click="chooseOption4('b')">-->
                        <!--                                        <div id="question_b_text">B. {{ options.B }}</div>-->
                        <!--                                    </div>-->
                        <!--                                    <div id="option-C" class="option_1" style="display: none;" @click="chooseOption4('c')">-->
                        <!--                                        <div id="question_c_text">C. {{ options.C }}</div>-->
                        <!--                                    </div>-->
                        <!--                                    <div id="option-D" class="option_1" style="display: none;" @click="chooseOption4('d')">-->

                        <!--                                        <div id="question_d_text">D. {{ options.D }}</div>-->
                        <!--                                    </div>-->
                        <!--                                    <button type="button" id="last_button" @click="lastProblem"></button>-->
                        <!--                                    <button type="button" id="next_button" @click="nextProblem"></button>-->
                        <!--                                </div>-->
                        <div id="kantuxuanyin_part" style="display: none">
                            <div class="option_2">
                                <div class="optionBox" id="option_A2"
                                     style="float:left;width: 220px;margin-right: 100px">
                                    <img src="/image/audio-unselected.png" class="option_audio" id="option_a_audio"
                                         @click="playAudio('A')">
                                    <img src="/image/finger.gif" class="finger" style="margin-left: 55px !important;">
                                    <div id="problem_a_text" @click="chooseOption3('a')">A. {{ options.A }}</div>
                                </div>
                                <div class="optionBox" id="option_B2" style="float:left;width: 220px;">
                                    <img src="/image/audio-unselected.png" class="option_audio" id="option_b_audio"
                                         @click="playAudio('B')">
                                    <img src="/image/finger.gif" class="finger" style="margin-left: 55px !important;">
                                    <div id="problem_b_text" @click="chooseOption3('b')">B. {{ options.B }}</div>
                                </div>
                            </div>
                            <div class="option_2">
                                <div class="optionBox" id="option_C2"
                                     style="float:left;display: none;margin-right: 100px;width: 220px">
                                    <img src="/image/audio-unselected.png" id="option_c_audio" class="option_audio"
                                         @click="playAudio('C')">
                                    <img src="/image/finger.gif" class="finger" style="margin-left: 55px !important;">
                                    <div id="problem_c_text" v-if="option_c_aud != ''" @click="chooseOption3('c')">C. {{
                                        options.C }}
                                    </div>
                                </div>
                                <div class="optionBox" id="option_D2" style="float:left;display: none;width: 220px">
                                    <img src="/image/audio-unselected.png" id="option_d_audio" class="option_audio"
                                         @click="playAudio('D')">
                                    <img src="/image/finger.gif" class="finger" style="margin-left: 55px !important;">
                                    <div id="problem_d_text" v-if="option_d_aud != ''" @click="chooseOption3('d')">D. {{
                                        options.D }}
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="last_button" @click="lastProblem"></button>
                            <button type="button" id="next_button" @click="nextProblem"></button>
                        </div>
                        <div id="tingyinxuanci_part" style="display: none">
                            <div id="option_A3" class="option_3" @click="chooseOption2('a')">
                                <div class="option_img_container" v-if="option_a_img&&option_a_img != ''">
                                    <div class="imgSize1">
                                        <img class="option_img" id="option_a_img" :src=option_a_img
                                             onload="changeSize(this,'option','a')">
                                    </div>
                                </div>
                                <div id="prob_a_text">A. {{ options.A }}</div>
                            </div>
                            <div id="option_B3" class="option_3" @click="chooseOption2('b')">

                                <div class="option_img_container" v-if="option_b_img&&option_b_img != ''">
                                    <div class="imgSize1">
                                        <img class="option_img" id="option_b_img" :src=option_b_img
                                             onload="changeSize(this,'option','b')">
                                    </div>
                                </div>
                                <div id="prob_b_text">B. {{ options.B }}</div>
                            </div>
                            <div id="option_C3" class="option_3" style="display: none;" @click="chooseOption2('c')">
                                <div class="option_img_container" v-if="option_c_img && option_c_img != ''">
                                    <div class="imgSize1">
                                        <img class="option_img" id="option_c_img" :src=option_c_img
                                             onload="changeSize(this,'option','c')">
                                    </div>
                                </div>
                                <div id="prob_c_text">C. {{ options.C }}</div>
                            </div>
                            <div id="option_D3" class="option_3" style="display: none;" @click="chooseOption2('d')">
                                <div class="option_img_container" v-if="option_d_img && option_d_img != ''">
                                    <div class="imgSize1">
                                        <img class="option_img" id="option_d_img" :src=option_d_img
                                             onload="changeSize(this,'option','d')">
                                    </div>
                                </div>
                                <div id="prob_d_text">D. {{ options.D }}</div>
                            </div>
                            <button type="button" id="last_button" @click="lastProblem"></button>
                            <button type="button" id="next_button" @click="nextProblem"></button>
                        </div>
                        <div id="panduanzhengwu_part" style="display: none">
                            <div class="option_2">
                                <div class="optionBox" id="option_A" style="float:left"><span>A.</span><img
                                        src="/image/true-unselected.png" class="option_judge" id="option_a_judge"
                                        @click="judge('A')"></div>
                                <div class="optionBox" id="option_B" style="float:left"><span>B.</span><img
                                        src="/image/false-unselected.png" class="option_judge" id="option_b_judge"
                                        @click="judge('B')"></div>
                            </div>

                            <button type="button" id="last_button" @click="lastProblem"></button>
                            <button type="button" id="next_button" @click="nextProblem"></button>
                        </div>
                        <div id="txt_part" style="display: none;">
                            <div id="input_box">
                                <div v-for="input in input_num">
                                    <el-input v-model=txt[input] :id="getIndex(input)" :disabled="false" prefix-icon=""
                                              class="input_bar"></el-input>
                                </div>
                            </div>
                            <button type="button" id="last_button" @click="lastProblem"></button>
                            <button type="button" id="next_button" @click="nextProblem"></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="footer">
                <div id="container3">
                    <button type="button" id="finish_button" @click="handIn"></button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    function changeSize(img, type, num = 'e') {
        let image = new Image();
        image.src = img.src;
        if (image.width >= image.height) {
            let el;
            if (type == 'stem') {
                el = document.getElementById('image');
            } else if (type == 'option') {
                el = document.getElementById('option_' + num + '_img');
            }
            el.style.width = "100%";
            el.style.height = "auto";
            console.log(image.width)
            console.log(image.height)
            if (image.height > image.width * 0.88) {
                el.style.width = "90%";
                el.style.height = "auto";
            }

        } else {
            let el;
            if (type == 'stem') {
                el = document.getElementById('image');
            } else if (type == 'option') {
                el = document.getElementById('option_' + num + '_img');
            }
            el.style.width = "auto";
            el.style.height = "100%";
            console.log(image.width)
            console.log(image.height)
            if (image.width > image.height * 0.88) {
                el.style.width = "90%";
                el.style.height = "auto";
            }


        }
    }

    function audioFlicker(el) {
        let tmp = el.src.split('/');
        if (tmp[tmp.length - 1] == 'audio-unchecked.png') {
            el.src = "/image/audio-checked.png";
        } else {
            el.src = "/image/audio-unchecked.png";
        }
        ;
    }

    function setCookie(cname, cvalue) {
        document.cookie = cname + "=" + cvalue + "; ";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) === 0)
                return c.substring(name.length, c.length);
        }
        return "";
    }

    function handInConfirm() {
        sessionStorage.clear();
        window.location.replace("/demo_marked?src=" + app.src + "&mode=finish&id=" + app.id);
    };

    function handInCancel() {
        document.getElementById("whole").style.filter = "brightness(1)";
        document.getElementById("pop_container").style.zIndex = "0";
    };

    window.addEventListener('resize', () => {
        var deviceWidth = document.documentElement.clientWidth;
        document.getElementById("app").style.transformOrigin = "left top";
        document.getElementById("app").style.transform = "scale(" + (deviceWidth / 1533) + ")";
        document.getElementById("pop_container").style.transformOrigin = "left top";
        document.getElementById("pop_container").style.transform = "scale(" + (deviceWidth / 1533) + ")";
        document.getElementById("top_bar").style.transformOrigin = "left top";
        document.getElementById("top_bar").style.transform = "scale(" + (deviceWidth / 1533) + ")";
    }, false);

    window.addEventListener("orientationchange", () => {
        if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
            var deviceWidth = document.documentElement.clientWidth;
            var deviceHeight = document.documentElement.clientHeight;
            if (window.orientation == 0 || window.orientation == 180) {
                deviceWidth = (deviceWidth < deviceHeight) ? deviceWidth : deviceHeight;
                document.getElementById("app").style.transformOrigin = "left top";
                document.getElementById("app").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                document.getElementById("pop_container").style.transformOrigin = "left top";
                document.getElementById("pop_container").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                document.getElementById("top_bar").style.transformOrigin = "left top";
                document.getElementById("top_bar").style.transform = "scale(" + (deviceWidth / 1533) + ")";
            }
            if (window.orientation == 90 || window.orientation == -90) {
                deviceWidth = (deviceWidth > deviceHeight) ? deviceWidth : deviceHeight;
                document.getElementById("app").style.transformOrigin = "left top";
                document.getElementById("app").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                document.getElementById("pop_container").style.transformOrigin = "left top";
                document.getElementById("pop_container").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                document.getElementById("top_bar").style.transformOrigin = "left top";
                document.getElementById("top_bar").style.transform = "scale(" + (deviceWidth / 1533) + ")";
            }
        }
    });

    var app = new Vue({
        el: "#app",
        data: {
            handin: false,
            num: 1,
            totalNum: 0,
            opt_num: 0,
            opt_choice_num: 0,
            opt_tingyinxuanwen_num: 0,
            opt_kantuxuanyin_num: 0,
            opt_tingyinxuanci_num: 0,
            opt_panduanzhengwu_num: 0,
            remain: -1,
            id: 0,    //全局的 this.id 指的是一份试卷 sheetTemp 的 id
            level: 0,
            lesson: 0,
            prob_list: [],
            done_list: [],
            opt_box: [],
            opt_choice_box: [],
            opt_tingyinxuanwen_box: [],
            opt_kantuxuanyin_box: [],
            opt_tingyinxuanci_box: [],
            opt_panduanzhengwu_box: [],
            txt_box: [],
            src: "",
            imgSrc: "",
            prob_text: "test",
            prob_attr: "",
            prob_type: "",
            options_id: 0,
            options: {A: "", B: "", C: "", D: ""},
            formData: {
                idx: 0,
                finish: 0,
                choice: "",
                choice_text: ""
            },
            setting: {
                src: "",
                sys: "",
                lev: 0,
                probNum: 0
            },
            options_list: [],
            answers_list: [],
            txt: [], //文本题的输入
            input_num: [],
            activities: [],
            intervals: [0, 0, 0, 0, 0],
            stem_img: "",
            option_a_img: "",
            option_b_img: "",
            option_c_img: "",
            option_d_img: "",
            stem_aud: "",
            option_a_aud: "",
            option_b_aud: "",
            option_c_aud: "",
            option_d_aud: "",
            a_play: "/image/audio-unselected.png",
            b_play: "/image/audio-unselected.png",
            c_play: "/image/audio-unselected.png",
            d_play: "/image/audio-unselected.png",
            last_span_text: "",
        },
        methods: {
            musicEnd: function (num) {
                switch (num) {
                    case 0: {
                        clearInterval(this.intervals[0]);

                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                        break;
                    }
                    case 1: {
                        clearInterval(this.intervals[1]);
                        document.getElementById('option_a_audio').src = this.a_play;
                        break;
                    }
                    case 2: {
                        clearInterval(this.intervals[2]);
                        document.getElementById('option_b_audio').src = this.b_play;
                        break;
                    }
                    case 3: {
                        clearInterval(this.intervals[3]);
                        document.getElementById('option_c_audio').src = this.c_play;
                        break;
                    }
                    case 4: {
                        clearInterval(this.intervals[4]);
                        document.getElementById('option_d_audio').src = this.d_play;
                        break;
                    }
                }
            },

            pauseMusic: function () {
                document.getElementById('stem_music').pause();
                document.getElementById('option_a_music').pause();
                document.getElementById('option_b_music').pause();
                document.getElementById('option_c_music').pause();
                document.getElementById('option_d_music').pause();
                for (let i = 0; i < 5; i++) {
                    clearInterval(this.intervals[i])
                    this.intervals[i] = 0;
                }
            },

            playAudio: function (problem) {
                if (problem == 'stem') {
                    let el = document.getElementById('stem_audio');
                    let music = document.getElementById('stem_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for (let i = 0; i < this.intervals.length; i++) {
                            if (this.intervals[i] != 0) {
                                if (i == 1)
                                    document.getElementById('option_a_audio').src = "/image/audio-checked.png";
                                else if (i == 2)
                                    document.getElementById('option_b_audio').src = "/image/audio-checked.png";
                                else if (i == 3)
                                    document.getElementById('option_c_audio').src = "/image/audio-checked.png";
                                else if (i == 4)
                                    document.getElementById('option_d_audio').src = "/image/audio-checked.png";
                                clearInterval(this.intervals[i]);
                                this.intervals[i] = 0;
                            }
                        }

                        music.src = this.stem_aud;

                        music.play();
                        this.intervals[0] = setInterval(function () {
                            audioFlicker(el);
                        }, 500);
                    } else {
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[0]);
                        this.intervals[0] = 0;
                        el.src = "/image/audio-unchecked.png";
                    }
                } else if (problem == 'A') {

                    if (document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if (document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if (document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;
                    let el = document.getElementById('option_a_audio');
                    let music = document.getElementById('option_a_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for (let i = 0; i < this.intervals.length; i++) {
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_a_aud;
                        music.play();
                        this.intervals[1] = setInterval(function () {
                            audioFlicker(el);
                        }, 500);
                    } else {
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[1]);
                        this.intervals[0] = 0;
                        el.src = this.a_play;
                    }
                } else if (problem == 'B') {

                    if (document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if (document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if (document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;

                    let el = document.getElementById('option_b_audio');
                    let music = document.getElementById('option_b_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for (let i = 0; i < this.intervals.length; i++) {
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_b_aud;
                        music.play();
                        this.intervals[2] = setInterval(function () {
                            audioFlicker(el);
                        }, 500);
                    } else {
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[2]);
                        this.intervals[2] = 0;
                        el.src = this.b_play;
                    }
                } else if (problem == 'C') {

                    if (document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if (document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if (document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;

                    let el = document.getElementById('option_c_audio');
                    let music = document.getElementById('option_c_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for (let i = 0; i < this.intervals.length; i++) {
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_c_aud;
                        music.play();
                        this.intervals[3] = setInterval(function () {
                            audioFlicker(el);
                        }, 500);
                    } else {
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[3]);
                        this.intervals[3] = 0;
                        el.src = this.c_play;
                    }
                } else if (problem == 'D') {

                    if (document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if (document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if (document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;

                    let el = document.getElementById('option_d_audio');
                    let music = document.getElementById('option_d_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for (let i = 0; i < this.intervals.length; i++) {
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_d_aud;
                        music.play();
                        this.intervals[4] = setInterval(function () {
                            audioFlicker(el);
                        }, 500);
                    } else {
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[4]);
                        this.intervals[4] = 0;
                        el.src = this.d_play;
                    }
                }
            },

            judge: function (option) {
                this.refreshAnswer3();
                option = option.toUpperCase();
                this.formData.choice = option;
                if (option == 'A') {
                    el = document.getElementById('option_a_judge');
                    el.src = '/image/true-selected.png';
                    el.style.width = "75px";
                    el.style.height = "75px";
                } else if (option == 'B') {
                    el = document.getElementById('option_b_judge');
                    el.src = '/image/false-selected.png';
                    el.style.width = "75px";
                    el.style.height = "75px";
                }
                if (this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum - (this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            goBack: function () {
                sessionStorage.clear();
                window.location.replace("https://www.smartreelearners.com/#/home");
            },

            chooseOption: function (option) {
                this.refreshAnswer();
                document.getElementById('option_' + option.toUpperCase()).style.background = "#00D87E";
                document.getElementById('option_' + option.toUpperCase()).style.color = "white";
                this.formData.choice = option;
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                }
                if (this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum - (this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                console.log(this.formData)
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            chooseOption2: function (option) {
                this.refreshAnswer4();
                document.getElementById('prob_' + option + '_text').style.background = "#00D87E";
                document.getElementById('prob_' + option + '_text').style.color = "white";
                this.formData.choice = option;
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                }
                if (this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum - (this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            chooseOption3: function (option) {
                console.log('chooseOption:' + option)
                this.pauseMusic();
                document.getElementById('option_a_audio').src = 'image/audio-unselected.png';
                document.getElementById('option_b_audio').src = 'image/audio-unselected.png';
                document.getElementById('option_c_audio').src = 'image/audio-unselected.png';
                document.getElementById('option_d_audio').src = 'image/audio-unselected.png';
                document.getElementById('option_' + option + '_audio').src = '/image/audio-checked.png';

                this.refreshAnswer2();
                document.getElementById('problem_' + option + '_text').style.background = "#00D87E";
                document.getElementById('problem_' + option + '_text').style.color = "white";
                this.formData.choice = option;
                this.refreshMusic();
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                    this.a_play = "/image/audio-checked.png";
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                    this.b_play = "/image/audio-checked.png";
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                    this.c_play = "/image/audio-checked.png";
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                    this.d_play = "/image/audio-checked.png";
                }
                if (this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum - (this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            chooseOption4: function (option) {
                this.refreshAnswer1();
                document.getElementById('option-' + option.toUpperCase()).style.background = "#00D87E";
                document.getElementById('option-' + option.toUpperCase()).style.color = "white";
                this.formData.choice = option;
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                }
                if (this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum - (this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            refreshAnswer: function () {
                if (document.getElementById('option_A')) {
                    document.getElementById('option_A').style.background = "#F0F0F0";
                    document.getElementById('option_A').style.color = "black";
                }
                if (document.getElementById('option_B')) {
                    document.getElementById('option_B').style.background = "#F0F0F0";
                    document.getElementById('option_B').style.color = "black";
                }
                if (document.getElementById('option_C')) {
                    document.getElementById('option_C').style.background = "#F0F0F0";
                    document.getElementById('option_C').style.color = "black";
                }
                if (document.getElementById('option_D')) {
                    document.getElementById('option_D').style.background = "#F0F0F0";
                    document.getElementById('option_D').style.color = "black";
                }
            },

            refreshAnswer1: function () {
                if (document.getElementById('option-A')) {
                    document.getElementById('option-A').style.background = "#F0F0F0";
                    document.getElementById('option-A').style.color = "black";
                }
                if (document.getElementById('option-B')) {
                    document.getElementById('option-B').style.background = "#F0F0F0";
                    document.getElementById('option-B').style.color = "black";
                }
                if (document.getElementById('option-C')) {
                    document.getElementById('option-C').style.background = "#F0F0F0";
                    document.getElementById('option-C').style.color = "black";
                }
                if (document.getElementById('option-D')) {
                    document.getElementById('option-D').style.background = "#F0F0F0";
                    document.getElementById('option-D').style.color = "black";
                }
            },

            refreshAnswer2: function () {
                if (document.getElementById('problem_a_text')) {
                    document.getElementById('problem_a_text').style.background = "#F0F0F0";
                    document.getElementById('problem_a_text').style.color = "black";
                }
                if (document.getElementById('problem_b_text')) {
                    document.getElementById('problem_b_text').style.background = "#F0F0F0";
                    document.getElementById('problem_b_text').style.color = "black";
                }
                if (document.getElementById('problem_c_text')) {
                    document.getElementById('problem_c_text').style.background = "#F0F0F0";
                    document.getElementById('problem_c_text').style.color = "black";
                }
                if (document.getElementById('problem_d_text')) {
                    document.getElementById('problem_d_text').style.background = "#F0F0F0";
                    document.getElementById('problem_d_text').style.color = "black";
                }
            },

            refreshAnswer3: function () {
                let el = document.getElementById('option_a_judge');
                el.src = 'image/true-unselected.png';
                el.style.width = "65px";
                el.style.height = "65px";
                el = document.getElementById('option_b_judge');
                el.src = 'image/false-unselected.png';
                el.style.width = "65px";
                el.style.height = "65px";
            },

            refreshAnswer4: function () {
                if (document.getElementById('prob_a_text')) {
                    document.getElementById('prob_a_text').style.background = "#F0F0F0";
                    document.getElementById('prob_a_text').style.color = "black";
                }
                if (document.getElementById('prob_b_text')) {
                    document.getElementById('prob_b_text').style.background = "#F0F0F0";
                    document.getElementById('prob_b_text').style.color = "black";
                }
                if (document.getElementById('prob_c_text')) {
                    document.getElementById('prob_c_text').style.background = "#F0F0F0";
                    document.getElementById('prob_c_text').style.color = "black";
                }
                if (document.getElementById('prob_d_text')) {
                    document.getElementById('prob_d_text').style.background = "#F0F0F0";
                    document.getElementById('prob_d_text').style.color = "black";
                }
            },

            refreshMusic: function () {
                this.a_play = "/image/audio-unselected.png";
                this.b_play = "/image/audio-unselected.png";
                this.c_play = "/image/audio-unselected.png";
                this.d_play = "/image/audio-unselected.png";
            },

            getIndex: function (option) {
                return "text" + (option + 1);
            },

            getId: function (option) {
                return "icon_" + option;
            },

            getNum: function (option) {
                return "num_" + option;
            },

            confirm: function () {
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.choice = "none";
                this.formData.finish = 1;
                this.formData.choice_text = this.txt.join("$");
                if (this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum - (this.done_list.push(this.num));
                }
                axios.post("/postSheet", $.param(this.formData)
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            lastProblem: function () {
                this.pauseMusic();
                this.refreshMusic();
                for (let i = 0; i < 5; i++) {
                    if (this.intervals[i] != 0) {
                        clearInterval(this.intervals[i]);
                        this.intervals[i] = 0;
                    }
                }
                if (this.num > 1) {
                    if (this.num === (this.opt_num + 1)) {
                        for (var i = 0; i < this.txt.length; i++) {
                            if (this.txt[i] !== "") {
                                this.confirm();
                                break;
                            }
                        }
                        this.num -= 1;
                        this.refreshAnswer();
                        this.refreshAnswer2();
                        this.refreshAnswer3();
                        this.refreshAnswer4();
                        this.rememberOpt(this.num);
                    } else if (this.num > (this.opt_num + 1)) {
                        for (var i = 0; i < this.txt.length; i++) {
                            if (this.txt[i] !== "") {
                                this.confirm();
                                break;
                            }
                        }
                        this.num -= 1;
                        this.rememberTxt(this.num);
                    } else {
                        this.num -= 1;
                        this.refreshAnswer();
                        this.refreshAnswer2();
                        this.refreshAnswer3();
                        this.refreshAnswer4();
                        this.rememberOpt(this.num);
                    }
                    this.store();
                    this.$nextTick(() => {
                        this.fetchProblem();
                    });
                } else {
                    this.$message({
                        type: 'info',
                        message: '这是第一题'
                    });
                }
            },

            nextProblem: function () {
                this.pauseMusic();
                this.refreshMusic();
                for (let i = 0; i < 5; i++) {
                    if (this.intervals[i] != 0) {
                        clearInterval(this.intervals[i]);
                        this.intervals[i] = 0;
                    }
                }
                if (this.num < this.totalNum) {
                    if (this.num === this.opt_num) {
                        this.num = this.num + 1;
                        this.rememberTxt(this.num);
                    } else if (this.num > this.opt_num) {
                        for (var i = 0; i < this.txt.length; i++) {
                            if (this.txt[i] !== "") {
                                this.confirm();
                                break;
                            }
                        }
                        this.num += 1;
                        this.rememberTxt(this.num);
                    } else {
                        this.num = this.num + 1;
                        this.refreshAnswer();
                        this.refreshAnswer2();
                        this.refreshAnswer3();
                        this.refreshAnswer4();
                        this.rememberOpt(this.num);
                    }
                    this.store();
                    this.$nextTick(() => {
                        this.fetchProblem();
                    });
                } else {
                    for (var i = 0; i < this.txt.length; i++) {
                        if (this.txt[i] !== "") {
                            this.confirm();
                            break;
                        }
                    }
                    this.$message({
                        type: 'info',
                        message: '已经是最后一题了'
                    });
                }
            },

            handIn: function () {
                if (this.num > this.opt_num) {
                    for (var i = 0; i < this.txt.length; i++) {
                        if (this.txt[i] !== "") {
                            this.confirm();
                            break;
                        }
                    }
                }
                if (this.remain > 0) {
                    this.handin = true;
                    document.getElementById("whole").style.filter = "brightness(0.85)";
                    document.getElementById("pop_container").style.zIndex = "1";
                    document.getElementById("remain_text").innerHTML = this.remain + "道题";
                } else {
                    //var url = sessionStorage.getItem('lastUrl');
                    //history.replaceState(null,null,url);
                    sessionStorage.clear();
                    window.location.replace("/demo_marked?src=" + this.src + "&mode=finish&id=" + this.id);
                }
            },

            getSheet: function () {
                return new Promise(resolve => {
                    axios.get("/getSheet"
                    ).then((response) => {
                        this.options_list = response.data.sheet_list;
                        resolve(response.data.sheet_list);
                    });
                })
            },

            setSheet: async function () {
                this.options_list = await this.getSheet();
                for (var i = 0; i < this.options_list.length; i++) {
                    ans = this.options_list[i];
                    console.log(ans);
                    if (ans.finish === 1) {
                        var index = this.prob_list.indexOf(ans["idx"]);
                        this.activities[index]["src"] = "/image/yellow-star.png";
                        document.getElementById("num_" + (index + 1)).style.color = "#2A7DE1";
                    }
                }

                this.store();
            },

            getInitPaper: function () {
                return new Promise(resolve => {
                    axios.get("/initPaper"
                    ).then((response) => {
                        resolve(response.data);
                    });
                })
            },

            setInitPaper: async function () {
                if (this.remain === -1) {
                    var res = await this.getInitPaper();
                    this.totalNum = res.sheet_list.length;
                    if (this.totalNum === 0) {
                        this.$alert('这个页面目前还没有题目，请点击返回主界面', '提示', {
                            confirmButtonText: '确定',
                            callback: action => {
                                window.location.replace("/start");
                            }
                        });
                    }
                    this.prob_list = res.num_list;   //直接获取题号序列
                    this.opt_num = res.opt_num;
                    this.id = res.id;
                    this.remain = this.totalNum;
                    this.opt_box = [];
                    this.txt_box = [];
                    this.opt_choice_box = [];
                    this.opt_kantuxuanyin_box = [];
                    this.opt_tingyinxuanci_box = [];
                    this.opt_panduanzhengwu_box = [];

                    for (var j = 1; j <= this.totalNum; j++) {
                        var activityTemp = {};
                        activityTemp.content = 'Q' + j.toString();
                        activityTemp.index = j;
                        activityTemp.src = '/image/grey-star.png';
                        this.activities.push(activityTemp);
                        if (res.sheet_list[j - 1].layoutType == "text") {
                            this.opt_choice_box.push(j);
                            this.opt_box.push(j);
                        } else if (res.sheet_list[j - 1].layoutType == "image") {
                            this.opt_tingyinxuanci_box.push(j);
                            this.opt_box.push(j);
                        } else if (res.sheet_list[j - 1].layoutType == "audio") {
                            this.opt_kantuxuanyin_box.push(j);
                            this.opt_box.push(j);
                        } else if (res.sheet_list[j - 1].layoutType == "panduanzhengwu") {
                            this.opt_panduanzhengwu_box.push(j);
                            this.opt_box.push(j);
                        } else if (res.sheet_list[j - 1].layoutType == "txt") {
                            this.txt_box.push(j);
                        }
                    }
                }
                this.fetchProblem();
            },

            openView: function (part) {
                document.getElementById('opt_part').style.display = "none";
                document.getElementById('kantuxuanyin_part').style.display = "none";
                document.getElementById('tingyinxuanci_part').style.display = "none";
                document.getElementById('panduanzhengwu_part').style.display = "none";
                document.getElementById('txt_part').style.display = "none";
                document.getElementById(part + '_part').style.display = "";
            },

            getImage: function (str) {
                var img = new Image();
                img.src = "/image/_prob/" + str + ".png";
                if (img.complete) {
                    document.getElementById("img_size").style.width = "100%";
                    document.getElementById("img_size").style.height = "100%";
                    if (img.width > img.height) {
                        document.getElementById("img_size").style.height = "auto";
                    } else {
                        document.getElementById("img_size").style.width = "auto";
                    }
                } else {
                    img.onload = function () {
                        document.getElementById("img_size").style.width = "100%";
                        document.getElementById("img_size").style.height = "100%";
                        if (img.width > img.height) {
                            document.getElementById("img_size").style.height = "auto";
                        } else {
                            document.getElementById("img_size").style.width = "auto";
                        }
                    };
                }
                this.imgSrc = img.src;
            },

            fetchProblem: async function () {
                this.stem_img = "";
                this.option_a_img = "";
                this.option_b_img = "";
                this.option_c_img = "";
                this.option_d_img = "";
                this.stem_aud = "";
                this.option_a_aud = "";
                this.option_b_aud = "";
                this.option_c_aud = "";
                this.option_d_aud = "";
                this.imgSrc = "";
                this.prob_text = "";
                this.prob_attr = "";
                this.prob_type = "";
                this.options_id = 0;
                this.options.A = "";
                this.options.B = "";
                this.options.C = "";
                this.options.D = "";
                this.last_span_text = "";
                var prob = await axios.get("/getProblem?num=" + this.prob_list[this.num - 1].toString());
                if (prob.data.prob_text && prob.data.prob_text != "") {
                    this.prob_text = prob.data.prob_text;
                    this.last_span_text = this.prob_text.split('\n')[this.prob_text.split('\n').length - 1];
                }
                console.log(this.prob_text.split('\n'))
                let stem_text = this.prob_text.split('\n');
                let parent = document.getElementById('question_text');
                let child = document.getElementById('last_span');
                while (parent.children[0] != child)
                    parent.removeChild(parent.children[0]);
                for (let i = 0; i < stem_text.length - 1; i++) {
                    var p = document.createElement('div');
                    p.style.lineHeight = "55px";
                    p.innerHTML = stem_text[i];
                    parent.insertBefore(p, child);
                    //p.style.border = "1px solid black";
                }
                document.getElementById('question_text').style.width = "94%";
                document.getElementById('image_container').style.display = "none";
                switch (prob.data.prob_attr) {
                    case "Choice": {
                        this.prob_type = prob.data.prob_type;
                        this.options_id = prob.data.options_id;
                        var option = await axios.get("/getOptions?id=" + this.options_id);
                        switch (option.data.choice_type) {
                            case 'text': {
                                this.openView('opt');
                                document.getElementById('question_text').style.width = "66%";
                                let tmp = document.getElementById('image_container');
                                tmp.style.display = "";
                                if (!prob.data.image_url || prob.data.image_url == "") {
                                    tmp = document.getElementById('image');
                                    tmp.src = "/image/logo.png";
                                    tmp.style.width = "100%";
                                    tmp.style.height = "100%";
                                    tmp = document.getElementsByClassName('imgSize')[0];
                                    tmp.style.borderRadius = "0";
                                    tmp = document.getElementById('image_container');
                                    tmp.style.backgroundImage = "none";
                                } else {
                                    this.stem_img = prob.data.image_url;
                                    document.getElementById('image_container').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                                    document.getElementById('image').src = this.stem_img;
                                    document.getElementsByClassName('imgSize')[0].style.borderRadius = "16px";
                                }

                                this.options.A = option.data.option_a;
                                this.options.B = option.data.option_b;
                                if (option.data.hasOwnProperty('option_c') && (option.data.option_c !== null) && (option.data.option_c.length > 0)) {
                                    this.options.C = option.data.option_c;
                                    document.getElementById('option_C').style.display = "";
                                } else {
                                    this.options.C = "";
                                    document.getElementById('option_C').style.display = "none";
                                }
                                if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                                    this.options.D = option.data.option_d;
                                    document.getElementById('option_D').style.display = "";
                                } else {
                                    this.options.D = "";
                                    document.getElementById('option_D').style.display = "none";
                                }
                                break;
                            }
                            case 'image': {
                                this.openView('tingyinxuanci');
                                if (prob.data.audio_url && prob.data.audio_url != "")
                                    this.stem_aud = prob.data.audio_url;
                                this.options_id = prob.data.options_id;
                                var option = await axios.get("/getOptions?id=" + this.options_id);
                                this.options.A = option.data.option_a;
                                this.options.B = option.data.option_b;
                                if (option.data.hasOwnProperty('option_c') && (option.data.option_c !== null) && (option.data.option_c.length > 0)) {
                                    this.options.C = option.data.option_c;
                                    document.getElementById('option_C3').style.display = "";
                                } else {
                                    this.options.C = "";
                                    document.getElementById('option_C3').style.display = "none";
                                }
                                if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                                    this.options.D = option.data.option_d;
                                    document.getElementById('option_D3').style.display = "";
                                } else {
                                    this.options.D = "";
                                    document.getElementById('option_D3').style.display = "none";
                                }
                                if (option.data.hasOwnProperty('a_image_url') && (option.data.a_image_url !== null) && (option.data.a_image_url.length > 0)) {
                                    this.option_a_img = option.data.a_image_url;
                                } else {
                                    this.option_a_img = "";
                                }
                                if (option.data.hasOwnProperty('b_image_url') && (option.data.b_image_url !== null) && (option.data.b_image_url.length > 0)) {
                                    this.option_b_img = option.data.b_image_url;
                                } else {
                                    this.option_b_img = "";
                                }
                                if (option.data.hasOwnProperty('c_image_url') && (option.data.c_image_url !== null) && (option.data.c_image_url.length > 0)) {
                                    this.option_c_img = option.data.c_image_url;
                                } else {
                                    this.option_c_img = "";
                                }
                                if (option.data.hasOwnProperty('d_image_url') && (option.data.d_image_url !== null) && (option.data.d_image_url.length > 0)) {
                                    this.option_d_img = option.data.d_image_url;
                                } else {
                                    this.option_d_img = "";
                                }
                                break;
                            }
                            case 'audio': {
                                this.openView('kantuxuanyin');
                                document.getElementById('question_text').style.width = "66%";
                                let tmp = document.getElementById('image_container');
                                tmp.style.display = "";
                                tmp.style.display = "";
                                if (!prob.data.image_url || prob.data.image_url == "") {
                                    tmp = document.getElementById('image');
                                    tmp.src = "/image/logo.png";
                                    tmp.style.width = "100%";
                                    tmp.style.height = "100%";
                                    tmp = document.getElementsByClassName('imgSize')[0];
                                    tmp.style.borderRadius = "0";
                                    tmp = document.getElementById('image_container');
                                    tmp.style.backgroundImage = "none";
                                } else {
                                    this.stem_img = prob.data.image_url;
                                    document.getElementById('image_container').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                                    document.getElementById('image').src = this.stem_img;
                                    document.getElementsByClassName('imgSize')[0].style.borderRadius = "16px";
                                }
                                this.options_id = prob.data.options_id;
                                var option = await axios.get("/getOptions?id=" + this.options_id);
                                console.log(option)
                                this.options.A = option.data.option_a;
                                this.options.B = option.data.option_b;
                                if (option.data.hasOwnProperty('option_c') && (option.data.option_c !== null) && (option.data.option_c.length > 0)) {
                                    this.options.C = option.data.option_c;
                                } else {
                                    this.options.C = "";

                                }
                                if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                                    this.options.D = option.data.option_d;
                                } else {
                                    this.options.D = "";
                                }
                                this.option_a_aud = option.data.a_audio_url;
                                this.option_b_aud = option.data.b_audio_url;
                                if (option.data.hasOwnProperty('c_audio_url') && (option.data.c_audio_url !== null) && (option.data.c_audio_url.length > 0)) {
                                    this.option_c_aud = option.data.c_audio_url;
                                    document.getElementById('option_C2').style.display = "";
                                } else {
                                    this.options.C = "";
                                    this.option_c_aud = "";
                                    document.getElementById('option_C2').style.display = "none";
                                }
                                if (option.data.hasOwnProperty('d_audio_url') && (option.data.d_audio_url !== null) && (option.data.d_audio_url.length > 0)) {
                                    this.option_d_aud = option.data.d_audio_url;
                                    document.getElementById('option_D2').style.display = "";
                                } else {
                                    this.options.D = "";
                                    this.option_d_aud = "";
                                    document.getElementById('option_D2').style.display = "none";
                                }
                                break;
                            }
                        }
                        break;
                    }
                    case "panduanzhengwu": {
                        this.prob_type = "判断正误";
                        this.openView('panduanzhengwu');
                        document.getElementById('question_text').style.width = "66%";
                        let tmp = document.getElementById('image_container');
                        tmp.style.display = "";
                        if (!prob.data.image_url || prob.data.image_url == "") {
                            tmp = document.getElementById('image');
                            tmp.src = "/image/logo.png";
                            tmp.style.width = "100%";
                            tmp.style.height = "100%";
                            tmp = document.getElementsByClassName('imgSize')[0];
                            tmp.style.borderRadius = "0";
                            tmp = document.getElementById('image_container');
                            tmp.style.backgroundImage = "none";
                        } else {
                            this.stem_img = prob.data.image_url;
                            document.getElementById('image_container').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                            document.getElementById('image').src = this.stem_img;
                            document.getElementsByClassName('imgSize')[0].style.borderRadius = "16px";
                        }
                        if (prob.data.audio_url && prob.data.audio_url != "")
                            this.stem_aud = prob.data.audio_url;
                        break;
                    }
                    case "txt": {
                        this.txt = [];
                        this.openView('txt');
                        document.getElementById('question_text').style.width = "66%";
                        let tmp = document.getElementById('image_container');
                        tmp.style.display = "";
                        if (!prob.data.image_url || prob.data.image_url == "") {
                            tmp = document.getElementById('image');
                            tmp.src = "/image/logo.png";
                            tmp.style.width = "100%";
                            tmp.style.height = "100%";
                            tmp = document.getElementsByClassName('imgSize')[0];
                            tmp.style.borderRadius = "0";
                            tmp = document.getElementById('image_container');
                            tmp.style.backgroundImage = "none";
                        } else {
                            this.stem_img = prob.data.image_url;
                            document.getElementById('image_container').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                            document.getElementById('image').src = this.stem_img;
                            document.getElementsByClassName('imgSize')[0].style.borderRadius = "16px";
                        }
                        if (prob.data.audio_url && prob.data.audio_url != "")
                            this.stem_aud = prob.data.audio_url;
                        if (prob.data.prob_type === "Correct") {
                            this.prob_type = "改错题";
                        } else if (prob.data.prob_type === "Fill") {
                            this.prob_type = "填空题";
                        } else if (prob.data.prob_type === "Rewrite") {
                            this.prob_type = "改写题";
                        } else if (prob.data.prob_type === "Translation") {
                            this.prob_type = "翻译题";
                        } else {
                            //处理特殊情况
                            this.prob_type = "文本题";
                        }
                        for (let i = 0; i < prob.data.blank_num; i++) {//2记得改为prob.data.blank_num
                            this.txt.push("");
                        }
                        this.input_num = [...Array(prob.data.blank_num).keys()];//2记得改为prob.data.blank_num
                        this.prob_text = prob.data.prob_text;
                        break;
                    }
                }
                for (var j = 1; j <= this.totalNum; j++) {
                    if (j === this.num) {
                        document.getElementById("icon_" + j).style.width = "47.4%";
                        document.getElementById("icon_" + j).style.height = "46.9%";
                        document.getElementById("icon_" + j).style.margin = "0";
                        document.getElementById("num_" + j).style.fontSize = "1.25rem";
                    } else {
                        document.getElementById("icon_" + j).style.width = "33.1%";
                        document.getElementById("icon_" + j).style.height = "32.9%";
                        document.getElementById("icon_" + j).style.margin = "5% 0 0 0"
                        document.getElementById("num_" + j).style.fontSize = "1rem";
                    }
                }
            },


            rememberOpt: function (option) {
                axios.get("/getSheet").then((response) => {
                    let flag = false;
                    for (var i = 0; i < response.data.sheet_list.length; i++) {
                        if (((this.prob_list.indexOf(response.data.sheet_list[i].idx) + 1) === option) && (response.data.sheet_list[i].finish === 1)) {
                            for (var j = 0; flag == false && j < this.opt_choice_box.length; j++) {
                                if (this.opt_choice_box[j] == option) {
                                    document.getElementById('option_' + response.data.sheet_list[i].choice.toUpperCase()).style.background = "#00D87E";
                                    document.getElementById('option_' + response.data.sheet_list[i].choice.toUpperCase()).style.color = "white";
                                    flag = true;
                                }
                            }
                            // for(var j = 0 ;flag == false && j < this.opt_tingyinxuanwen_box.length; j++) {
                            //     if(this.opt_tingyinxuanwen_box[j] == option){
                            //         document.getElementById('option-'+response.data.sheet_list[i].choice.toUpperCase()).style.background = "#00D87E";
                            //         document.getElementById('option-'+response.data.sheet_list[i].choice.toUpperCase()).style.color = "white";
                            //         flag = true;
                            //     }
                            // }
                            for (var j = 0; flag == false && j < this.opt_kantuxuanyin_box.length; j++) {
                                if (this.opt_kantuxuanyin_box[j] == option) {
                                    document.getElementById('option_' + response.data.sheet_list[i].choice.toLowerCase() + "_audio").src = "/image/audio-checked.png";
                                    document.getElementById('problem_' + response.data.sheet_list[i].choice.toLowerCase() + "_text").style.background = "#00D87E";
                                    document.getElementById('problem_' + response.data.sheet_list[i].choice.toLowerCase() + "_text").style.color = "white";
                                    flag = true;
                                }
                            }
                            for (var j = 0; flag == false && j < this.opt_tingyinxuanci_box.length; j++) {
                                if (this.opt_tingyinxuanci_box[j] == option) {
                                    document.getElementById('prob_' + response.data.sheet_list[i].choice.toLowerCase() + "_text").style.background = "#00D87E";
                                    document.getElementById('prob_' + response.data.sheet_list[i].choice.toLowerCase() + "_text").style.color = "white";
                                    flag = true;
                                }
                            }
                            for (var j = 0; flag == false && j < this.opt_panduanzhengwu_box.length; j++) {
                                if (this.opt_panduanzhengwu_box[j] == option) {
                                    if (response.data.sheet_list[i].choice.toLowerCase() == 'a')
                                        document.getElementById('option_a_judge').src = "/image/true-selected.png";
                                    else
                                        document.getElementById('option_b_judge').src = "/image/false-selected.png";
                                    flag = true;
                                }
                            }
                            break;
                        }
                    }
                });
            },

            rememberTxt: function (option) {
                axios.get("/getSheet").then((response) => {
                    var sl = response.data.sheet_list;
                    for (var i = 0; i < sl.length; i++) {
                        if ((this.prob_list.indexOf(sl[i].idx) + 1) === option) {
                            if (sl[i].choice_text !== null) {
                                this.txt = sl[i].choice_text.split("$");
                                break;
                            }
                        }
                    }
                });
            },

            store: function () {
                sessionStorage.setItem('questionId', this.num.toString());
                sessionStorage.setItem('remainNum', this.remain.toString());
                sessionStorage.setItem('total', this.totalNum.toString());
                sessionStorage.setItem('opt', this.opt_num.toString());
                // sessionStorage.setItem('opt_choice',this.opt_choice_num.toString());
                // sessionStorage.setItem('opt_tingyinxuanwen',this.opt_tingyinxuanwen_num.toString());
                // sessionStorage.setItem('opt_kantuxuanyin',this.opt_kantuxuanyin_num.toString());
                // sessionStorage.setItem('opt_tingyinxuanci',this.opt_tingyinxuanci_num.toString());
                // sessionStorage.setItem('opt_panduanzhengwu',this.opt_panduanzhengwu_num.toString());
                sessionStorage.setItem('list', this.done_list.toString());
                sessionStorage.setItem('optlist', this.opt_box.toString());
                sessionStorage.setItem('choicelist', this.opt_choice_box.toString());
                // sessionStorage.setItem('tingyinxuanwenlist',this.opt_tingyinxuanwen_box.toString());
                sessionStorage.setItem('kantuxuanyinlist', this.opt_kantuxuanyin_box.toString());
                sessionStorage.setItem('tingyinxuancilist', this.opt_tingyinxuanci_box.toString());
                sessionStorage.setItem('panduanzhengwulist', this.opt_panduanzhengwu_box.toString());
                sessionStorage.setItem('txtlist', this.txt_box.toString());
                sessionStorage.setItem('problist', this.prob_list.toString());
                sessionStorage.setItem('src', this.src);
                sessionStorage.setItem('id', this.id);
                sessionStorage.setItem('level', this.level);
                sessionStorage.setItem('lesson', this.lesson);
                sessionStorage.setItem('activities', JSON.stringify(this.activities));
            },
        },

        created() {
            if (getCookie('user_id') !== null) {
                if (getCookie('user_id') === "") {
                    localStorage.clear();
                    window.location.replace('/login');
                }
            } else {
                window.location.replace('/login');
            }
            if (sessionStorage.getItem('questionId') !== null) {  // 如果已经进入刷题状态了，就读取 session
                console.log("已有 sessionStorage", sessionStorage.getItem('questionId'));
                this.num = parseInt(sessionStorage.getItem('questionId'));
                this.remain = parseInt(sessionStorage.getItem('remainNum'));
                this.totalNum = parseInt(sessionStorage.getItem('total'));
                this.opt_num = parseInt(sessionStorage.getItem('opt'));
                // this.opt_choice_num = parseInt(sessionStorage.getItem('opt_choice'));
                // this.opt_tingyinxuanwen_num = parseInt(sessionStorage.getItem('opt_tingyinxuanwen'));
                // this.opt_kantuxuanyin_num = parseInt(sessionStorage.getItem('opt_kantuxuanyin'));
                // this.opt_tingyinxuanci_num = parseInt(sessionStorage.getItem('opt_tingyinxuanci'));
                // this.opt_panduanzhengwu_num = parseInt(sessionStorage.getItem('opt_panduanzhengwu'));
                this.src = sessionStorage.getItem('src');
                if (sessionStorage.getItem('optlist') !== "") {
                    this.opt_box = sessionStorage.getItem('optlist').split(',').map(Number);
                }
                if (sessionStorage.getItem('choicelist') !== "") {
                    this.opt_choice_box = sessionStorage.getItem('choicelist').split(',').map(Number);
                }
                // if(sessionStorage.getItem('tingyinxuanwenlist') !== "") {
                //     this.opt_tingyinxuanwen_box = sessionStorage.getItem('tingyinxuanwenlist').split(',').map(Number);
                // }
                if (sessionStorage.getItem('kantuxuanyinlist') !== "") {
                    this.opt_kantuxuanyin_box = sessionStorage.getItem('kantuxuanyinlist').split(',').map(Number);
                }
                if (sessionStorage.getItem('tingyinxuancilist') !== "") {
                    this.opt_tingyinxuanci_box = sessionStorage.getItem('tingyinxuancilist').split(',').map(Number);
                }
                if (sessionStorage.getItem('panduanzhengwulist') !== "") {
                    this.opt_panduanzhengwu_box = sessionStorage.getItem('panduanzhengwulist').split(',').map(Number);
                }
                if (sessionStorage.getItem('txtlist') !== "") {
                    this.txt_box = sessionStorage.getItem('txtlist').split(',').map(Number);
                }
                if (sessionStorage.getItem('problist') !== "") {
                    this.prob_list = sessionStorage.getItem('problist').split(',').map(Number);
                }
                this.id = parseInt(sessionStorage.getItem('id'));
                this.level = parseInt(sessionStorage.getItem('level'));
                this.lesson = parseInt(sessionStorage.getItem('lesson'));
                if (sessionStorage.getItem('list') !== "") {
                    this.done_list = sessionStorage.getItem('list').split(',').map(Number);
                }
                this.activities = JSON.parse(sessionStorage.getItem('activities'));
            } else {   // 未在刷题状态，设置新的 param
                console.log("未在刷题状态，设置新的 param");
                if (window.location.search.indexOf("lesson") > -1) {
                    this.src = "lesson";
                    this.level = parseInt(sessionStorage.getItem("level"));
                    this.lesson = parseInt(sessionStorage.getItem("lesson"));
                } else if (window.location.search.indexOf("strengthen") > -1) {
                    this.src = "strengthen";
                    this.level = parseInt(sessionStorage.getItem("level"));
                    this.lesson = parseInt(sessionStorage.getItem("lesson"));
                    document.getElementById("heading2").innerHTML = "推荐练习";
                } else if (window.location.search.indexOf("wrong") > -1) {
                    this.src = "wrong";
                    document.getElementById("heading1").innerHTML = "错题练习";
                    document.getElementById("heading2").style.display = "none";
                }
            }
            this.setSheet();
            this.setInitPaper();
            window.onbeforeunload = function (event) {
                var url = sessionStorage.getItem('lastUrl');
                history.replaceState('change', null, url);
            }
            if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
                var deviceWidth = document.documentElement.clientWidth;
                var deviceHeight = document.documentElement.clientHeight;
                if (window.orientation == 0 || window.orientation == 180) {
                    deviceWidth = (deviceWidth < deviceHeight) ? deviceWidth : deviceHeight;
                    document.getElementById("app").style.transformOrigin = "left top";
                    document.getElementById("app").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                    document.getElementById("pop_container").style.transformOrigin = "left top";
                    document.getElementById("pop_container").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                    document.getElementById("top_bar").style.transformOrigin = "left top";
                    document.getElementById("top_bar").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                }
                if (window.orientation == 90 || window.orientation == -90) {
                    deviceWidth = (deviceWidth > deviceHeight) ? deviceWidth : deviceHeight;
                    document.getElementById("app").style.transformOrigin = "left top";
                    document.getElementById("app").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                    document.getElementById("pop_container").style.transformOrigin = "left top";
                    document.getElementById("pop_container").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                    document.getElementById("top_bar").style.transformOrigin = "left top";
                    document.getElementById("top_bar").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                }
            } else {
                var deviceWidth = document.documentElement.clientWidth;
                document.getElementById("app").style.transformOrigin = "left top";
                document.getElementById("app").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                document.getElementById("pop_container").style.transformOrigin = "left top";
                document.getElementById("pop_container").style.transform = "scale(" + (deviceWidth / 1533) + ")";
                document.getElementById("top_bar").style.transformOrigin = "left top";
                document.getElementById("top_bar").style.transform = "scale(" + (deviceWidth / 1533) + ")";
            }
        },

        // mounted() {
        //     if(this.num <= this.opt_num) {
        //         this.rememberOpt(this.num);
        //         if(this.num <= this.opt_choice_num)
        //             this.openView('opt');
        //         else if(this.num <= this.opt_choice_num + this.opt_tingyinxuanwen_num)
        //             this.openView('tingyinxuanwen');
        //         else if(this.num <= this.opt_choice_num + this.opt_tingyinxuanwen_num + this.opt_kantuxuanyin_num)
        //             this.openView('kantuxuanyin');
        //         else if(this.num <= this.opt_choice_num + this.opt_tingyinxuanwen_num + this.opt_kantuxuanyin_num + this.opt_tingyinxuanci_num)
        //             this.openView('tingyinxuanci');
        //         else
        //             this.openView('panduanzhengwu');
        //     }else {
        //         this.rememberTxt(this.num);
        //         this.openView('txt');
        //     }
        // },

        async mounted() {
            window["musicEnd"] = (num) => {
                this.musicEnd(num);
            }
        },
    })
</script>