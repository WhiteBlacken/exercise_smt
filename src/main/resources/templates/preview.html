<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <title>预览界面</title>
    <meta http-equiv="content-type" content="text/html charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;"/>
    <link href="/css/demo_marked.css" type="text/css" rel="stylesheet" charset="utf-8">
    <link href="/css/index.css" type="text/css" rel="stylesheet" charset="utf-8">
    <script src="/js/vue@2.6.10.js"></script>
    <script src="/js/axios@0.18.0.min.js"></script>
    <script src="/js/index.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.cookie.js"></script>
</head>
<body>
<div id="app">
    <div id="musicBox">
        <audio id="stem_music" onended="musicEnd(0)"></audio>
        <audio id="option_a_music" onended="musicEnd(1)"></audio>
        <audio id="option_b_music" onended="musicEnd(2)"></audio>
        <audio id="option_c_music" onended="musicEnd(3)"></audio>
        <audio id="option_d_music" onended="musicEnd(4)"></audio>
    </div>
    <div id="layer" v-show="handin"></div>
    <img id="popBox" v-show="handin" src="/image/pop_box.png"></img>
    <div id="pop_msg" v-show="handin">
        <p><span style="color: #DCDCDC;">你还有 </span><span style="color: #FF8900;">{{ remain }}道题</span><span style="color: #DCDCDC;"> 未完成，是否交卷？</span></p>
    </div>
    <button type="button" id="handIn_confirm" v-show="handin" ></button>
    <button type="button" id="handIn_cancel" v-show="handin" ></button>
    <div id="main">
        <div id="header">
            <div id="container1">
                <div id="heading">
                    <p id="heading1"><span>Level {{ level }} Lesson {{ lesson }}</span></p>
                    <p id="heading2"><span>智能推送练习</span></p>
                </div>
            </div>
            <div id="container2">
                <div id="heading3">
                    <ul class="time">
                        <el-divider id="line"></el-divider>
                        <li v-for="activity in activities">
                            <img :src="activity.src" :id="getId(activity.index)"></i>
                            <p :id="getNum(activity.index)"><span>{{ activity.content }}</span></p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <img id="link_left" src="/image/link.png">
        <img id="link_right" src="/image/link.png">
        <div id="question_card">
            <div id="book_container">
                <img src="/image/book.png" id="book">
                <div id="question_area">
                    <div id="image_container2" style="display: none">
                        <div class="imgSize2">
                            <img src="/image/logo.png" id="image2" onload="changeSize(this,'stem')">
                            <!--                                        <img src="/image/testGif.gif" id="image">-->
                            <!--                                        <img src="/image/testGif2.gif" id="test" width="100px" height="100px">-->
                        </div>
                    </div>
                    <div id="question_info">
                        <p style="font-family: 'GothamRoundedMedium';color: #2A7DE1;font-size: 42px;"><span>Q{{ num }}</span></p>
                        <div style="border-radius: 40px;background-color: #2A7DE1;font-family: 'Microsoft YaHei';color: white;font-weight: bold;font-size: 20px;margin-left: 10px;padding-left: 5px;padding-right: 5px;">
                            <p><span>{{ prob_attr }}</span></p>
                        </div>
                    </div>
                    <div id="question_text">
                        <p><span style="line-height: 55px">{{ prob_text }}</span><img v-if="stem_aud && stem_aud != ''" id="stem_audio" src="/image/audio-unchecked.png" @click="playAudio('stem')"><img v-if="stem_aud && stem_aud != ''" src="/image/finger.png" class="finger"></p>
                    </div>
                    <div id="opt_part" style="display: none">
                        <div id="img_container" v-if="level != 1 || lesson != 1">
                            <img :src="imgSrc" id="image" onerror="this.src='/image/logo.png'">
                        </div>
                        <div id="option_A" class="option" @click="chooseOption('a')">
                            <div id="question_a_text">
                                <p class="choice"><span>A. {{ options.A }}</span></p>
                            </div>
                        </div>
                        <div id="option_B" class="option" @click="chooseOption('b')">
                            <div id="question_b_text">
                                <p class="choice"><span>B. {{ options.B }}</span></p>
                            </div>
                        </div>
                        <div id="option_C" class="option" @click="chooseOption('c')">
                            <div id="question_c_text">
                                <p class="choice"><span>C. {{ options.C }}</span></p>
                            </div>
                        </div>
                        <div id="option_D" class="option" style="display: none;" @click="chooseOption('d')">
                            <div id="question_d_text">
                                <p class="choice"><span>D. {{ options.D }}</span></p>
                            </div>
                        </div>
                    </div>
                    <div id="tingyinxuanwen_part" style="display: none">

                        <div id="option-A" class="option_1" @click="chooseOption4('a')">
                            <div id="question_a_text">A. {{ options.A }}</div>
                        </div>
                        <div id="option-B" class="option_1" @click="chooseOption4('b')">
                            <div id="question_b_text">B. {{ options.B }}</div>
                        </div>
                        <div id="option-C" class="option_1" style="display: none;" @click="chooseOption4('c')">
                            <div id="question_c_text">C. {{ options.C }}</div>
                        </div>
                        <div id="option-D" class="option_1" style="display: none;" @click="chooseOption4('d')">

                            <div id="question_d_text">D. {{ options.D }}</div>
                        </div>
                    </div>
                    <div id="kantuxuanyin_part" style="display: none">
                        <div class="option_2" >
                            <div class="optionBox" id="option_A2" style="float:left;width: 220px;margin-right: 100px">
                                <img src="/image/audio-unselected.png" class="option_audio" id="option_a_audio" @click="playAudio('A')">
                                <img src="/image/finger.png" class="finger" style="margin-left: 55px !important;">
                                <div id="problem_a_text" @click="chooseOption3('a')">A. {{ options.A }}</div>
                            </div>
                            <div class="optionBox" id="option_B2" style="float:left;width: 220px;">
                                <img src="/image/audio-unselected.png" class="option_audio" id="option_b_audio" @click="playAudio('B')">
                                <img src="/image/finger.png" class="finger" style="margin-left: 55px !important;">
                                <div id="problem_b_text" @click="chooseOption3('b')">B. {{ options.B }}</div>
                            </div>
                        </div>
                        <div class="option_2">
                            <div class="optionBox" id="option_C2" style="float:left;display: none;margin-right: 100px;width: 220px">
                                <img  src="/image/audio-unselected.png" id="option_c_audio" class="option_audio" @click="playAudio('C')">
                                <img src="/image/finger.png" class="finger" style="margin-left: 55px !important;">
                                <div id="problem_c_text" v-if="option_c_aud != ''" @click="chooseOption3('c')">C. {{ options.C }}</div>
                            </div>
                            <div class="optionBox" id="option_D2" style="float:left;display: none;width: 220px">
                                <img  src="/image/audio-unselected.png" id="option_d_audio" class="option_audio" @click="playAudio('D')">
                                <img src="/image/finger.png" class="finger" style="margin-left: 55px !important;">
                                <div id="problem_d_text" v-if="option_d_aud != ''" @click="chooseOption3('d')">D. {{ options.D }}</div>
                            </div>
                        </div>
                    </div>
                    <div id="tingyinxuanci_part" style="display: none">
                        <div id="option_A3" class="option_3" @click="chooseOption2('a')">
                            <div class="option_img_container" v-if="option_a_img&&option_a_img != ''">
                                <div class="imgSize1">
                                    <img class="option_img" id="option_a_img" :src=option_a_img onload="changeSize(this,'option','a')">
                                </div>
                            </div>
                            <div id="problem_a_text">A. {{ options.A }}</div>
                        </div>
                        <div id="option_B3" class="option_3" @click="chooseOption2('b')">

                            <div class="option_img_container" v-if="option_b_img&&option_b_img != ''">
                                <div class="imgSize1">
                                    <img class="option_img" id="option_b_img" :src=option_b_img onload="changeSize(this,'option','b')">
                                </div>
                            </div>
                            <div id="problem_b_text">B. {{ options.B }}</div>
                        </div>
                        <div id="option_C3" class="option_3" style="display: none;" @click="chooseOption2('c')">
                            <div class="option_img_container" v-if="option_c_img && option_c_img != ''">
                                <div class="imgSize1">
                                    <img class="option_img" id="option_c_img" :src=option_c_img onload="changeSize(this,'option','c')">
                                </div>
                            </div>
                            <div id="problem_c_text">C. {{ options.C }}</div>
                        </div>
                        <div id="option_D3" class="option_3" style="display: none;" @click="chooseOption2('d')">
                            <div class="option_img_container" v-if="option_d_img && option_d_img != ''">
                                <div class="imgSize1">
                                    <img class="option_img" id="option_d_img" :src=option_d_img onload="changeSize(this,'option','d')">
                                </div>
                            </div>
                            <div id="problem_d_text">D. {{ options.D }}</div>
                        </div>
                    </div>
                    <div id="panduanzhengwu_part" style="display: none">
                        <div class="option_2">
                            <div class="optionBox" id="option_A" style="float:left"><span>A.</span><img src="/image/true-unselected.png" class="option_judge" id="option_a_judge" @click="judge('A')"></div>
                            <div class="optionBox" id="option_B" style="float:left"><span>B.</span><img src="/image/false-unselected.png" class="option_judge" id="option_b_judge" @click="judge('B')"></div>
                        </div>
                    </div>
                    <div id="txt_part" style="display: none;">
                        <div id="img_container" v-if="level != 1 || lesson != 1">
                            <img :src="imgSrc" id="image" onerror="this.src='/image/logo.png'">
                        </div>
                        <div id="input_box">
                            <div v-for="input in input_num">
                                <el-input v-model=txt[input] :id="getIndex(input)" :disabled="false" prefix-icon="" class="input_bar"></el-input>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="analysis_area" v-if="level != 1 || lesson != 1">
                    <img id="analysis_background" src="/image/background.png">
                    <div id="analysis_text">
                        <p style="font-family: 'Microsoft YaHei';text-align: center;font-size: 1.5rem;font-weight: 600;"><span>本题解析</span></p>
                        <div style="position: relative;display: flex;align-items: center;z-index: inherit;margin: 0;padding: 0;width: 100%;height: 90%;"><p id="analysis_content"><span></span></p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    function changeSize (img,type,num='e') {
        let image = new Image();
        image.src = img.src;
        if(image.width >= image.height){
            let el;
            if(type == 'stem'){
                el = document.getElementById('image2');
            }else if(type == 'option'){
                el = document.getElementById('option_' + num + '_img');
            }
            el.style.width = "100%";
            el.style.height = "auto";
            console.log(image.width)
            console.log(image.height)
            if(image.height > image.width * 0.88){
                el.style.width = "90%";
                el.style.height = "auto";
            }

        }else {
            let el;
            if(type == 'stem'){
                el = document.getElementById('image2');
            }else if(type == 'option'){
                el = document.getElementById('option_' + num + '_img');
            }
            el.style.width = "auto";
            el.style.height = "100%";
            console.log(image.width)
            console.log(image.height)
            if(image.width > image.height * 0.88){
                el.style.width = "90%";
                el.style.height = "auto";
            }


        }
    }

    function audioFlicker (el) {
        let tmp = el.src.split('/');
        if (tmp[tmp.length - 1] == 'audio-unchecked.png') {
            el.src = "/image/audio-checked.png";
        } else {
            el.src = "/image/audio-unchecked.png";
        };
    }
    var app = new Vue({
        el: "#app",
        data: {
            imgSrc: "",
            handin: false,
            num: 1,
            totalNum: 0,
            opt_num: 0,
            remain: -1,
            id: 0,    //全局的 this.id 指的是一份试卷 sheetTemp 的 id
            level: 0,
            lesson: 0,
            prob_list: [],
            done_list: [],
            opt_box: [],
            txt_box: [],
            src: "",
            prob_text: "test",
            prob_attr: "",
            options_id: 0,
            options: {A: "A", B: "B", C: "C", D: "D"},
            analysis: '',
            formData: {
                idx: 0,
                finish: 0,
                choice: "",
                choice_text: ""
            },
            setting: {
                src: "",
                sys: "",
                lev: 0,
                probNum: 0
            },
            options_list: [],
            answers_list: [],
            txt: [],
            input_num: [],
            activities: [],
            intervals: [0,0,0,0,0],
            stem_img: "",
            option_a_img: "",
            option_b_img: "",
            option_c_img: "",
            option_d_img: "",
            stem_aud: "",
            option_a_aud: "",
            option_b_aud: "",
            option_c_aud: "",
            option_d_aud: "",
            a_play: "/image/audio-unselected.png",
            b_play: "/image/audio-unselected.png",
            c_play: "/image/audio-unselected.png",
            d_play: "/image/audio-unselected.png",
        },
        methods: {
            musicEnd: function (num) {
                switch(num){
                    case 0: {
                        clearInterval(this.intervals[0]);

                        document.getElementById('stem_audio').src= "/image/audio-unchecked.png";
                        break;
                    }
                    case 1: {
                        clearInterval(this.intervals[1]);
                        document.getElementById('option_a_audio').src= this.a_play;
                        break;
                    }
                    case 2: {
                        clearInterval(this.intervals[2]);
                        document.getElementById('option_b_audio').src= this.b_play;
                        break;
                    }
                    case 3: {
                        clearInterval(this.intervals[3]);
                        document.getElementById('option_c_audio').src= this.c_play;
                        break;
                    }
                    case 4: {
                        clearInterval(this.intervals[4]);
                        document.getElementById('option_d_audio').src= this.d_play;
                        break;
                    }
                }
            },

            pauseMusic: function () {
                document.getElementById('stem_music').pause();
                document.getElementById('option_a_music').pause();
                document.getElementById('option_b_music').pause();
                document.getElementById('option_c_music').pause();
                document.getElementById('option_d_music').pause();
                for(let i = 0; i < 5; i++){
                    clearInterval(this.intervals[i])
                    this.intervals[i] = 0;
                }
            },

            playAudio: function (problem) {
                if(problem == 'stem') {
                    let el = document.getElementById('stem_audio');
                    let music = document.getElementById('stem_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for(let i = 0; i < this.intervals.length; i++){
                            if(this.intervals[i] != 0){
                                if(i == 1)
                                    document.getElementById('option_a_audio').src = "/image/audio-checked.png";
                                else if(i == 2)
                                    document.getElementById('option_b_audio').src = "/image/audio-checked.png";
                                else if(i == 3)
                                    document.getElementById('option_c_audio').src = "/image/audio-checked.png";
                                else if(i == 4)
                                    document.getElementById('option_d_audio').src = "/image/audio-checked.png";
                                clearInterval(this.intervals[i]);
                                this.intervals[i] = 0;
                            }
                        }

                        music.src = this.stem_aud;

                        music.play();
                        this.intervals[0] = setInterval(function () {
                            audioFlicker(el);
                        },500);
                    }else{
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[0]);
                        this.intervals[0] = 0;
                        el.src = "/image/audio-unchecked.png";
                    }
                }else if(problem == 'A'){

                    if(document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if(document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if(document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;
                    let el = document.getElementById('option_a_audio');
                    let music = document.getElementById('option_a_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for(let i = 0; i < this.intervals.length; i++){
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_a_aud;
                        music.play();
                        this.intervals[1] = setInterval(function () {
                            audioFlicker(el);
                        },500);
                    }else{
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[1]);
                        this.intervals[0] = 0;
                        el.src = this.a_play;
                    }
                }else if(problem == 'B'){

                    if(document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if(document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if(document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;

                    let el = document.getElementById('option_b_audio');
                    let music = document.getElementById('option_b_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for(let i = 0; i < this.intervals.length; i++){
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_b_aud;
                        music.play();
                        this.intervals[2] = setInterval(function () {
                            audioFlicker(el);
                        },500);
                    }else{
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[2]);
                        this.intervals[2] = 0;
                        el.src = this.b_play;
                    }
                }else if(problem == 'C'){

                    if(document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if(document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if(document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;

                    let el = document.getElementById('option_c_audio');
                    let music = document.getElementById('option_c_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for(let i = 0; i < this.intervals.length; i++){
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_c_aud;
                        music.play();
                        this.intervals[3] = setInterval(function () {
                            audioFlicker(el);
                        },500);
                    }else{
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[3]);
                        this.intervals[3] = 0;
                        el.src = this.c_play;
                    }
                }else if(problem == 'D'){

                    if(document.getElementById('stem_audio'))
                        document.getElementById('stem_audio').src = "/image/audio-unchecked.png";
                    document.getElementById('option_a_audio').src = this.a_play;
                    document.getElementById('option_b_audio').src = this.b_play;
                    if(document.getElementById('option_c_audio'))
                        document.getElementById('option_c_audio').src = this.c_play;
                    if(document.getElementById('option_d_audio'))
                        document.getElementById('option_d_audio').src = this.d_play;

                    let el = document.getElementById('option_d_audio');
                    let music = document.getElementById('option_d_music');
                    if (music.paused) {
                        this.pauseMusic();
                        for(let i = 0; i < this.intervals.length; i++){
                            clearInterval(this.intervals[i]);
                            this.intervals[i] = 0;
                        }

                        music.src = this.option_d_aud;
                        music.play();
                        this.intervals[4] = setInterval(function () {
                            audioFlicker(el);
                        },500);
                    }else{
                        music.pause();
                        music.currentTime = 0;
                        clearInterval(this.intervals[4]);
                        this.intervals[4] = 0;
                        el.src = this.d_play;
                    }
                }
            },

            judge: function (option) {
                this.refreshAnswer3();
                option = option.toUpperCase();
                this.formData.choice = option;
                if(option == 'A'){
                    el = document.getElementById('option_a_judge');
                    el.src = '/image/true-selected.png';
                    el.style.width = "75px";
                    el.style.height = "75px";
                }else if(option == 'B'){
                    el = document.getElementById('option_b_judge');
                    el.src = '/image/false-selected.png';
                    el.style.width = "75px";
                    el.style.height = "75px";
                }
                if(this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum-(this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            chooseOption: function (option) {
                this.refreshAnswer();
                document.getElementById('option_' + option.toUpperCase()).style.background = "#00D87E";
                document.getElementById('option_' + option.toUpperCase()).style.color = "white";
                this.formData.choice = option;
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                }
                if(this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum-(this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
            },

            chooseOption2: function (option) {
                this.refreshAnswer2();
                document.getElementById('problem_' + option + '_text').style.background = "#00D87E";
                document.getElementById('problem_' + option + '_text').style.color = "white";
                this.formData.choice = option;
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                }
                if(this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum-(this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            chooseOption3: function (option) {
                console.log('chooseOption:'+option)
                this.pauseMusic();
                document.getElementById('option_a_audio').src='image/audio-unselected.png';
                document.getElementById('option_b_audio').src='image/audio-unselected.png';
                document.getElementById('option_c_audio').src='image/audio-unselected.png';
                document.getElementById('option_d_audio').src='image/audio-unselected.png';
                document.getElementById('option_'+option+'_audio').src='/image/audio-checked.png';

                this.refreshAnswer2();
                document.getElementById('problem_' + option + '_text').style.background = "#00D87E";
                document.getElementById('problem_' + option + '_text').style.color = "white";
                this.formData.choice = option;
                this.refreshMusic();
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                    this.a_play = "/image/audio-checked.png";
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                    this.b_play = "/image/audio-checked.png";
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                    this.c_play = "/image/audio-checked.png";
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                    this.d_play = "/image/audio-checked.png";
                }
                if(this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum-(this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            chooseOption4: function (option) {
                this.refreshAnswer1();
                document.getElementById('option-' + option.toUpperCase()).style.background = "#00D87E";
                document.getElementById('option-' + option.toUpperCase()).style.color = "white";
                this.formData.choice = option;
                if (option === 'a') {
                    this.formData.choice_text = this.options.A;
                } else if (option === 'b') {
                    this.formData.choice_text = this.options.B;
                } else if (option === 'c') {
                    this.formData.choice_text = this.options.C;
                } else if (option === 'd') {
                    this.formData.choice_text = this.options.D;
                }
                if(this.done_list.indexOf(this.num) === -1) {
                    this.remain = this.totalNum-(this.done_list.push(this.num));
                }
                this.formData.idx = this.prob_list[this.num - 1];
                this.formData.finish = 1;
                axios.post("/postSheet", $.param(this.formData)  //引入jQuery的作用
                ).then((response) => {
                    this.$nextTick(() => {
                        this.setSheet();
                    });
                });
            },

            refreshAnswer: function () {
                document.getElementById('option_A').style.background = "#F0F0F0";
                document.getElementById('option_A').style.color = "black";
                document.getElementById('option_B').style.background = "#F0F0F0";
                document.getElementById('option_B').style.color = "black";
                document.getElementById('option_C').style.background = "#F0F0F0";
                document.getElementById('option_C').style.color = "black";
                document.getElementById('option_D').style.background = "#F0F0F0";
                document.getElementById('option_D').style.color = "black";
            },

            refreshAnswer1: function () {
                document.getElementById('option-A').style.background = "#F0F0F0";
                document.getElementById('option-A').style.color = "black";
                document.getElementById('option-B').style.background = "#F0F0F0";
                document.getElementById('option-B').style.color = "black";
                document.getElementById('option-C').style.background = "#F0F0F0";
                document.getElementById('option-C').style.color = "black";
                document.getElementById('option-D').style.background = "#F0F0F0";
                document.getElementById('option-D').style.color = "black";
            },

            refreshAnswer2: function () {
                document.getElementById('problem_a_text').style.background = "#F0F0F0";
                document.getElementById('problem_a_text').style.color = "black";
                document.getElementById('problem_b_text').style.background = "#F0F0F0";
                document.getElementById('problem_b_text').style.color = "black";
                document.getElementById('problem_c_text').style.background = "#F0F0F0";
                document.getElementById('problem_c_text').style.color = "black";
                document.getElementById('problem_d_text').style.background = "#F0F0F0";
                document.getElementById('problem_d_text').style.color = "black";
            },

            refreshAnswer3: function () {
                let el = document.getElementById('option_a_judge');
                el.src = 'image/true-unselected.png';
                el.style.width = "65px";
                el.style.height = "65px";
                el = document.getElementById('option_b_judge');
                el.src = 'image/false-unselected.png';
                el.style.width = "65px";
                el.style.height = "65px";
            },

            refreshMusic: function () {
                this.a_play = "/image/audio-unselected.png";
                this.b_play = "/image/audio-unselected.png";
                this.c_play = "/image/audio-unselected.png";
                this.d_play = "/image/audio-unselected.png";
            },

            getIndex: function (option) {
                return "text" + (option + 1);
            },

            getId: function (option) {
                return "icon_" + option;
            },

            getNum: function (option) {
                return "num_" + option;
            },

            getImage: function (str) {
                var img = new Image();
                img.src = "/image/_prob/" + str + ".png";
                if(img.complete){
                    if(img.width > img.height)
                        document.getElementById("image").style.width = "100%";
                    else
                        document.getElementById("image").style.height = "100%";
                }else{
                    img.onload = function(){
                        if(img.width > img.height)
                            document.getElementById("image").style.width = "100%";
                        else
                            document.getElementById("image").style.height = "100%";
                    };
                }
                this.imgSrc = img.src;
            },

            fetchAnalysis: async function () {
                var analysisText = this.analysis_list[this.num - 1].split("\n");
                var tempString = "";
                for(var j = 0;j < analysisText.length;j++) {
                    tempString += (analysisText[j] + "<br />");
                }
                document.getElementById("analysis_content").innerHTML = tempString;
            },

            fetchProblem: async function () {
                if(this.level != 1 || this.lesson != 1) {
                    var prob_id = $.cookie("prob_id");
                    var prob = await axios.get("/getProblem?num=" + prob_id.toString());
                    console.log(prob.data);
                    this.level = prob.data.prob_level;
                    this.lesson = prob.data.lesson_id;
                    this.prob_text = prob.data.prob_text;
                    var answer = await axios.get("/getAnswer?id=" + prob_id.toString());
                    this.analysis = answer.data.analysis_text;
                    var analysisText = answer.data.analysis_text.split("\n");
                    var tempString = "";
                    for (var j = 0; j < analysisText.length; j++) {
                        tempString += (analysisText[j] + "<br />");
                    }
                    document.getElementById("analysis_content").innerHTML = tempString;
                    if (prob.data.prob_attr === "Choice") {
                        this.prob_attr = "选择";
                        this.openView('opt');
                        try {
                            this.getImage(this.prob_list[this.num - 1].toString());
                        } catch (e) {
                            //
                        }
                        this.options_id = prob.data.options_id;
                        var option = await axios.get("/getOptions?id=" + this.options_id);
                        this.options.A = option.data.option_a;
                        this.options.B = option.data.option_b;
                        this.options.C = option.data.option_c;
                        if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                            this.options.D = option.data.option_d;
                            document.getElementById('option_D').style.display = "";
                        } else {
                            this.options.D = "";
                            document.getElementById('option_D').style.display = "none";
                        }
                    } else {
                        this.txt = [];
                        this.openView('txt');
                        this.prob_attr = "改写";
                        try {
                            this.getImage(this.prob_list[this.num - 1].toString());
                        } catch (e) {
                            //
                        }
                        for (var i = 0; i < prob.data.blank_num; i++) {//2记得改为prob.data.blank_num
                            this.txt.push("");
                        }
                        this.input_num = [...Array(prob.data.blank_num).keys()];//2记得改为prob.data.blank_num
                        this.prob_text = prob.data.prob_text;
                        if (this.prob_text.toLowerCase().indexOf("question") > -1) {
                            if (this.prob_text.toLowerCase().indexOf("positive") > -1) {
                                document.getElementById("prob_tip").innerHTML = "改写句子：改写成疑问句+肯定回答";
                            } else if (this.prob_text.toLowerCase().indexOf("negative") > -1) {
                                document.getElementById("prob_tip").innerHTML = "改写句子：改写成疑问句+否定回答";
                            }
                        } else if (this.prob_text.toLowerCase().indexOf("sentence") > -1) {
                            if (this.prob_text.toLowerCase().indexOf("positive") > -1) {
                                document.getElementById("prob_tip").innerHTML = "改写句子：改写成肯定句";
                            } else if (this.prob_text.toLowerCase().indexOf("negative") > -1) {
                                document.getElementById("prob_tip").innerHTML = "改写句子：改写成否定句";
                            }
                        } else if (this.prob_text.toLowerCase().indexOf("answer") > -1) {
                            if (this.prob_text.toLowerCase().indexOf("positive") > -1) {
                                document.getElementById("prob_tip").innerHTML = "回答问题：用肯定句回答";
                            } else if (this.prob_text.toLowerCase().indexOf("negative") > -1) {
                                document.getElementById("prob_tip").innerHTML = "回答问题：用否定句回答";
                            }
                        }
                    }
                    for (var j = 1; j <= this.totalNum; j++) {
                        if (j === this.num) {
                            document.getElementById("icon_" + j).style.width = "30px";
                            document.getElementById("icon_" + j).style.height = "30px";
                            document.getElementById("icon_" + j).style.margin = "0px 0px 0px 0px";
                            document.getElementById("num_" + j).style.fontSize = "20px";
                        } else {
                            document.getElementById("icon_" + j).style.width = "21px";
                            document.getElementById("icon_" + j).style.height = "21px";
                            document.getElementById("icon_" + j).style.margin = "4px 0px 0px 0px"
                            document.getElementById("num_" + j).style.fontSize = "16px";
                        }
                    }
                }else{
                    this.stem_img = "";
                    this.option_a_img = "";
                    this.option_b_img = "";
                    this.option_c_img = "";
                    this.option_d_img = "";
                    this.stem_aud = "";
                    this.option_a_aud = "";
                    this.option_b_aud = "";
                    this.option_c_aud = "";
                    this.option_d_aud = "";
                    this.imgSrc = "";
                    this.prob_text = "";
                    this.prob_attr =  "";
                    this.options_id = 0;
                    this.options.A = "";
                    this.options.B = "";
                    this.options.C = "";
                    this.options.D = "";
                    var prob_id = $.cookie("prob_id");
                    var prob = await axios.get("/getProblem?num=" + prob_id.toString());
                    if(prob.data.prob_text && prob.data.prob_text != "")
                        this.prob_text = prob.data.prob_text;
                    document.getElementById('question_text').style.width = "94%";
                    document.getElementById('image_container2').style.display = "none";
                    switch (prob.data.prob_attr) {
                        case "Choice": {
                            this.prob_attr = "选择题";
                            this.openView('opt');
                            document.getElementById('question_text').style.width = "66%";
                            let tmp = document.getElementById('image_container2');
                            tmp.style.display = "";
                            if(!prob.data.image_url || prob.data.image_url == ""){
                                tmp = document.getElementById('image2');
                                tmp.src = "/image/logo.png";
                                tmp.style.width = "100%";
                                tmp.style.height = "100%";
                                tmp = document.getElementsByClassName('imgSize2')[0];
                                tmp.style.borderRadius = "0";
                                tmp = document.getElementById('image_container2');
                                tmp.style.backgroundImage = "none";
                            }else {
                                this.stem_img = prob.data.image_url;
                                document.getElementById('image_container2').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                                document.getElementById('image2').src = this.stem_img;
                                document.getElementsByClassName('imgSize2')[0].style.borderRadius = "16px";
                            }
                            this.options_id = prob.data.options_id;
                            var option = await axios.get("/getOptions?id=" + this.options_id);
                            this.options.A = option.data.option_a;
                            this.options.B = option.data.option_b;
                            if (option.data.hasOwnProperty('option_c') && (option.data.option_c !== null) && (option.data.option_c.length > 0)) {
                                this.options.C = option.data.option_c;
                                document.getElementById('option_C').style.display = "";
                            } else {
                                this.options.C = "";
                                document.getElementById('option_C').style.display = "none";
                            }
                            if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                                this.options.D = option.data.option_d;
                                document.getElementById('option_D').style.display = "";
                            } else {
                                this.options.D = "";
                                document.getElementById('option_D').style.display = "none";
                            }
                            break;
                        }
                        case "tingyinxuanwen": {
                            this.prob_attr = "听音选文";
                            this.openView('tingyinxuanwen');
                            if(prob.data.audio_url && prob.data.audio_url != "")
                                this.stem_aud = prob.data.audio_url;
                            this.options_id = prob.data.options_id;
                            var option = await axios.get("/getOptions?id=" + this.options_id);
                            this.options.A = option.data.option_a;
                            this.options.B = option.data.option_b;
                            if (option.data.hasOwnProperty('option_c') && (option.data.option_c !== null) && (option.data.option_c.length > 0)) {
                                this.options.C = option.data.option_c;
                                document.getElementById('option-C').style.display = "";
                            } else {
                                this.options.C = "";
                                document.getElementById('option-C').style.display = "none";
                            }
                            if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                                this.options.D = option.data.option_d;
                                document.getElementById('option-D').style.display = "";
                            } else {
                                this.options.D = "";
                                document.getElementById('option-D').style.display = "none";
                            }
                            break;
                        }
                        case "kantuxuanyin": {
                            this.prob_attr = "看图选音";
                            this.openView('kantuxuanyin');
                            document.getElementById('question_text').style.width = "66%";
                            let tmp = document.getElementById('image_container2');
                            tmp.style.display = "";
                            tmp.style.display = "";
                            if(!prob.data.image_url || prob.data.image_url == ""){
                                tmp = document.getElementById('image2');
                                tmp.src = "/image/logo.png";
                                tmp.style.width = "100%";
                                tmp.style.height = "100%";
                                tmp = document.getElementsByClassName('imgSize2')[0];
                                tmp.style.borderRadius = "0";
                                tmp = document.getElementById('image_container2');
                                tmp.style.backgroundImage = "none";
                            }else {
                                this.stem_img = prob.data.image_url;
                                document.getElementById('image_container2').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                                document.getElementById('image2').src = this.stem_img;
                                document.getElementsByClassName('imgSize2')[0].style.borderRadius = "16px";
                            }
                            this.options_id = prob.data.options_id;
                            var option = await axios.get("/getOptions?id=" + this.options_id);
                            console.log(option)
                            this.options.A = option.data.option_a;
                            this.options.B = option.data.option_b;
                            if (option.data.hasOwnProperty('option_c') && (option.data.option_c !== null) && (option.data.option_c.length > 0)) {
                                this.options.C = option.data.option_c;
                            } else {
                                this.options.C = "";

                            }
                            if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                                this.options.D = option.data.option_d;
                            } else {
                                this.options.D = "";
                            }
                            this.option_a_aud = option.data.a_audio_url;
                            this.option_b_aud = option.data.b_audio_url;
                            if (option.data.hasOwnProperty('c_audio_url') && (option.data.c_audio_url !== null) && (option.data.c_audio_url.length > 0)) {
                                this.option_c_aud = option.data.c_audio_url;
                                document.getElementById('option_C2').style.display = "";
                            } else {
                                this.options.C = "";
                                this.option_c_aud = "";
                                document.getElementById('option_C2').style.display = "none";
                            }
                            if (option.data.hasOwnProperty('d_audio_url') && (option.data.d_audio_url !== null) && (option.data.d_audio_url.length > 0)) {
                                this.option_d_aud = option.data.d_audio_url;
                                document.getElementById('option_D2').style.display = "";
                            } else {
                                this.options.D = "";
                                this.option_d_aud = "";
                                document.getElementById('option_D2').style.display = "none";
                            }
                            break;
                        }
                        case "tingyinxuanci": {
                            this.prob_attr = "听音选词";
                            this.openView('tingyinxuanci');
                            if(prob.data.audio_url && prob.data.audio_url != "")
                                this.stem_aud = prob.data.audio_url;
                            this.options_id = prob.data.options_id;
                            var option = await axios.get("/getOptions?id=" + this.options_id);
                            this.options.A = option.data.option_a;
                            this.options.B = option.data.option_b;
                            if (option.data.hasOwnProperty('option_c') && (option.data.option_c !== null) && (option.data.option_c.length > 0)) {
                                this.options.C = option.data.option_c;
                                document.getElementById('option_C3').style.display = "";
                            } else {
                                this.options.C = "";
                                document.getElementById('option_C3').style.display = "none";
                            }
                            if (option.data.hasOwnProperty('option_d') && (option.data.option_d !== null) && (option.data.option_d.length > 0)) {
                                this.options.D = option.data.option_d;
                                document.getElementById('option_D3').style.display = "";
                            } else {
                                this.options.D = "";
                                document.getElementById('option_D3').style.display = "none";
                            }
                            if (option.data.hasOwnProperty('a_image_url') && (option.data.a_image_url !== null) && (option.data.a_image_url.length > 0)) {
                                this.option_a_img = option.data.a_image_url;
                            } else {
                                this.option_a_img = "";
                            }
                            if (option.data.hasOwnProperty('b_image_url') && (option.data.b_image_url !== null) && (option.data.b_image_url.length > 0)) {
                                this.option_b_img = option.data.b_image_url;
                            } else {
                                this.option_b_img = "";
                            }
                            if (option.data.hasOwnProperty('c_image_url') && (option.data.c_image_url !== null) && (option.data.c_image_url.length > 0)) {
                                this.option_c_img = option.data.c_image_url;
                            } else {
                                this.option_c_img = "";
                            }
                            if (option.data.hasOwnProperty('d_image_url') && (option.data.d_image_url !== null) && (option.data.d_image_url.length > 0)) {
                                this.option_d_img = option.data.d_image_url;
                            } else {
                                this.option_d_img = "";
                            }
                            break;
                        }
                        case "panduanzhengwu": {
                            this.prob_attr = "判断正误";
                            this.openView('panduanzhengwu');
                            document.getElementById('question_text').style.width = "66%";
                            let tmp = document.getElementById('image_container2');
                            tmp.style.display = "";
                            if(!prob.data.image_url || prob.data.image_url == ""){
                                tmp = document.getElementById('image2');
                                tmp.src = "/image/logo.png";
                                tmp.style.width = "100%";
                                tmp.style.height = "100%";
                                tmp = document.getElementsByClassName('imgSize2')[0];
                                tmp.style.borderRadius = "0";
                                tmp = document.getElementById('image_container2');
                                tmp.style.backgroundImage = "none";
                            }else {
                                this.stem_img = prob.data.image_url;
                                document.getElementById('image_container2').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                                document.getElementById('image2').src = this.stem_img;
                                document.getElementsByClassName('imgSize2')[0].style.borderRadius = "16px";
                            }
                            if(prob.data.audio_url && prob.data.audio_url != "")
                                this.stem_aud = prob.data.audio_url;
                            break;
                        }
                        case "Correct":
                        case "Fill":
                        case "Rewrite":
                        case "Translation": {
                            this.txt = [];
                            this.openView('txt');
                            document.getElementById('question_text').style.width = "66%";
                            let tmp = document.getElementById('image_container2');
                            tmp.style.display = "";
                            if(!prob.data.image_url || prob.data.image_url == ""){
                                tmp = document.getElementById('image2');
                                tmp.src = "/image/logo.png";
                                tmp.style.width = "100%";
                                tmp.style.height = "100%";
                                tmp = document.getElementsByClassName('imgSize2')[0];
                                tmp.style.borderRadius = "0";
                                tmp = document.getElementById('image_container2');
                                tmp.style.backgroundImage = "none";
                            }else {
                                this.stem_img = prob.data.image_url;
                                document.getElementById('image_container2').style.backgroundImage = "repeating-linear-gradient(60deg,RGB(255,149,60), RGB(255,200,0))"
                                document.getElementById('image2').src = this.stem_img;
                                document.getElementsByClassName('imgSize2')[0].style.borderRadius = "16px";
                            }
                            if(prob.data.audio_url && prob.data.audio_url != "")
                                this.stem_aud = prob.data.audio_url;
                            if(prob.data.prob_attr === "Correct") {
                                this.prob_attr = "改错题";
                            }else if(prob.data.prob_attr === "Fill") {
                                this.prob_attr = "填空题";
                            }else if(prob.data.prob_attr === "Rewrite") {
                                this.prob_attr = "改写题";
                            }else if(prob.data.prob_attr === "Translation") {
                                this.prob_attr = "翻译题";
                            }
                            for(var i = 0;i < prob.data.blank_num;i++) {//2记得改为prob.data.blank_num
                                this.txt.push("");
                            }
                            this.input_num = [...Array(prob.data.blank_num).keys()];//2记得改为prob.data.blank_num
                            this.prob_text = prob.data.prob_text;
                            break;
                        }
                    }
                    for (var j = 1; j <= this.totalNum; j++) {
                        if(j === this.num) {
                            document.getElementById("icon_" + j).style.width = "47.4%";
                            document.getElementById("icon_" + j).style.height = "46.9%";
                            document.getElementById("icon_" + j).style.margin = "0";
                            document.getElementById("num_" + j).style.fontSize = "1.25rem";
                        }else {
                            document.getElementById("icon_" + j).style.width = "33.1%";
                            document.getElementById("icon_" + j).style.height = "32.9%";
                            document.getElementById("icon_" + j).style.margin = "5% 0 0 0"
                            document.getElementById("num_" + j).style.fontSize = "1rem";
                        }
                    }
                }
            },

            openView: function (part) {
                document.getElementById('opt_part').style.display = "none";
                document.getElementById('tingyinxuanwen_part').style.display = "none";
                document.getElementById('kantuxuanyin_part').style.display = "none";
                document.getElementById('tingyinxuanci_part').style.display = "none";
                document.getElementById('panduanzhengwu_part').style.display = "none";
                document.getElementById('txt_part').style.display = "none";
                document.getElementById(part + '_part').style.display = "";
            },
        },

        created() {
            this.level = $.cookie('level');
            this.lesson = $.cookie('lesson_id');
            this.fetchProblem();
        },

        async mounted() {
            window["musicEnd"] = (num) => {
                this.musicEnd(num);
            }
        },
    })
</script>